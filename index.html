<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Estoque ‚Äì BORA</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #6b7a90;
      --text: #e6edf7;
      --primary: #4aa3ff;
      --accent: #5ee6a8;
      --danger: #ff6b6b;
      --radius: 16px;
    }
    body {
      font-family: system-ui, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #17233b 0%, #0b1220 45%);
      color: var(--text);
      margin: 0;
    }
    header { background: rgba(11,18,32,0.8); border-bottom: 1px solid #1f2a44; position: sticky; top: 0; z-index: 20; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; }
    .brand .logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--accent)); display: grid; place-items: center; color: #0b1220; font-weight: 900; }
    button { border: none; cursor: pointer; border-radius: 10px; padding: 10px 14px; font-weight: 600; }
    .btn-primary { background: linear-gradient(180deg, #2a6ad9, #1e4fb0); color: white; }
    .btn-accent { background: linear-gradient(180deg, #1f7a5c, #145f47); color: white; }
    .btn-danger { background: linear-gradient(180deg, #b63b3b, #8f2a2a); color: white; }
    .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 1100px; margin: 20px auto; }
    .tab { text-align: center; padding: 10px; background: #131c2f; border: 1px solid #1f2a44; border-radius: 12px; cursor: pointer; color: var(--muted); }
    .tab.active { background: linear-gradient(180deg, #1a2741, #132038); color: white; }
    .card { background: #121a2b; border: 1px solid #1f2a44; border-radius: var(--radius); padding: 20px; max-width: 1100px; margin: 0 auto 40px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #1f2a44; text-align: left; }
    th { color: #9fb6d9; }
    input { width: 100%; padding: 10px; border: 1px solid #223055; border-radius: 8px; background: #0f1729; color: white; }
    label { color: #9fb6d9; font-size: 13px; }
    .grid { display: grid; gap: 16px; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .hidden { display: none; }
    .muted { color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div>Sistema de Estoque ‚Äì BORA</div>
        <div class="muted">SharePoint + Microsoft Forms</div>
      </div>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn-primary" id="btnAbrirFormEntrada">Abrir Formul√°rio ENTRADA</button>
      <button class="btn-danger" id="btnAbrirFormSaida">Abrir Formul√°rio SA√çDA</button>
      <button class="btn-accent" id="btnRecarregar">Recarregar Dados</button>
    </div>
  </div>
</header>

<div class="tabs" id="tabs">
  <div class="tab active" data-target="tab-produtos">Cadastro ‚Äì Produtos</div>
  <div class="tab" data-target="tab-entradas">Hist√≥rico ‚Äì Entradas</div>
  <div class="tab" data-target="tab-saidas">Hist√≥rico ‚Äì Sa√≠das</div>
  <div class="tab" data-target="tab-saldo">Saldo (Produtos)</div>
</div>

<!-- CADASTRO PRODUTOS -->
<section id="tab-produtos" class="card">
  <h2>üßæ Cadastro de Produtos</h2>
  <div class="grid grid-3">
    <div>
      <label>T√≠tulo (Nome do Produto)</label>
      <input id="pTitle" placeholder="Ex.: Parafuso M8 x 20mm">
    </div>
    <div>
      <label>C√≥digo do Fornecedor</label>
      <input id="pCodigoFornecedor" placeholder="Ex.: CF-12345">
    </div>
    <div>
      <label>C√≥digo de F√°brica</label>
      <input id="pCodigoFabrica" placeholder="Ex.: FAB-9876">
    </div>
    <div>
      <label>Descri√ß√£o do Produto</label>
      <input id="pDescricao" placeholder="Ex.: Parafuso zincado sextavado">
    </div>
    <div>
      <label>Nome do Fornecedor</label>
      <input id="pNomeFornecedor" placeholder="Ex.: ACME Pe√ßas">
    </div>
    <div>
      <label>Unidade de Medida</label>
      <input id="pUnidade" placeholder="Ex.: un, cx, kg">
    </div>
    <div>
      <label>Saldo Atual</label>
      <input id="pSaldoAtual" type="number" min="0" value="0">
    </div>
  </div>
  <br>
  <button class="btn-primary" id="btnSalvarProduto">üíæ Salvar Produto</button>
  <p id="saveStatus" class="muted"></p>
</section>

<!-- Entradas, Sa√≠das e Saldo permanecem iguais -->
<section id="tab-entradas" class="card hidden"><h2>üì• Hist√≥rico de Entradas</h2><div id="loaderEntradas" class="muted">Carregando...</div><table id="tableEntradas" class="hidden"><thead><tr><th>T√≠tulo</th><th>Quantidade</th><th>Valor Unit√°rio</th><th>Valor Total</th><th>Nota Fiscal</th></tr></thead><tbody></tbody></table></section>
<section id="tab-saidas" class="card hidden"><h2>üì§ Hist√≥rico de Sa√≠das</h2><div id="loaderSaidas" class="muted">Carregando...</div><table id="tableSaidas" class="hidden"><thead><tr><th>T√≠tulo</th><th>Descri√ß√£o</th><th>Quantidade</th><th>Placa Caminh√£o</th><th>Destinat√°rio</th></tr></thead><tbody></tbody></table></section>
<section id="tab-saldo" class="card hidden"><h2>üìä Saldo de Produtos</h2><button class="btn-accent" id="btnExportSaldo">‚¨áÔ∏è Exportar para Excel</button><div id="loaderSaldo" class="muted">Carregando...</div><table id="tableSaldo" class="hidden"><thead><tr><th>T√≠tulo</th><th>C√≥d. Fornecedor</th><th>C√≥d. F√°brica</th><th>Descri√ß√£o</th><th>Fornecedor</th><th>Unid.</th><th>Saldo</th><th>Atualiza√ß√£o</th></tr></thead><tbody></tbody></table></section>

<script>
const SHAREPOINT_SITE_ROOT = 'https://borexpress.sharepoint.com/sites/EstoqueJC';
const LIST_PRODUTOS = 'Produtos';
const FORM_URL_ENTRADA = 'https://forms.microsoft.com/r/8EaCX7pKRQ';
const FORM_URL_SAIDA   = 'https://forms.microsoft.com/r/n2Rr51aG6s';
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

async function spDigest() {
  const r = await fetch(`${SHAREPOINT_SITE_ROOT}/_api/contextinfo`, {
    method: "POST",
    headers: {"Accept": "application/json;odata=nometadata"}
  });
  const j = await r.json();
  return j.FormDigestValue;
}
async function spPostItem(listTitle, item) {
  const resp = await fetch("/api/saveProduto", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(item),
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(JSON.stringify(data.error || data));
  return data;
}

async function spGet(list, select) {
  const r = await fetch(`${SHAREPOINT_SITE_ROOT}/_api/web/lists/GetByTitle('${list}')/items?$select=${select}&$top=5000`, {
    headers: {"Accept": "application/json;odata=nometadata"}
  });
  const j = await r.json();
  return j.value || [];
}

$('#btnSalvarProduto').addEventListener('click', async () => {
  const title = $('#pTitle').value.trim();
  if (!title) return $('#saveStatus').innerText = '‚ö†Ô∏è Informe o t√≠tulo.';

  const item = {
    Title: title,
    CodigoFornecedor: $('#pCodigoFornecedor').value.trim(),
    CodigoFabrica: $('#pCodigoFabrica').value.trim(),
    DescricaoProduto: $('#pDescricao').value.trim(),
    NomeFornecedor: $('#pNomeFornecedor').value.trim(),
    UnidadeMedida: $('#pUnidade').value.trim(),
    SaldoAtual: Number($('#pSaldoAtual').value || 0),
    DataAtualizacao: new Date().toISOString()
  };

  $('#saveStatus').innerText = 'Salvando...';
  try {
    await spPostItem(LIST_PRODUTOS, item);
    $('#saveStatus').innerText = '‚úÖ Produto salvo com sucesso!';
    ['#pTitle','#pCodigoFornecedor','#pCodigoFabrica','#pDescricao','#pNomeFornecedor','#pUnidade','#pSaldoAtual']
      .forEach(id => $(id).value = '');
    loadProdutos();
    setActiveTab('tab-saldo');
  } catch(e) {
    $('#saveStatus').innerText = '‚ùå Erro ao salvar: ' + e.message;
  }
});

async function loadProdutos() {
  $('#loaderSaldo').classList.remove('hidden');
  const data = await spGet(LIST_PRODUTOS, 'Title,CodigoFornecedor,CodigoFabrica,DescricaoProduto,NomeFornecedor,UnidadeMedida,SaldoAtual,DataAtualizacao,Modified');
  const tbody = $('#tableSaldo tbody'); tbody.innerHTML = '';
  data.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i.Title??''}</td>
      <td>${i.CodigoFornecedor??''}</td>
      <td>${i.CodigoFabrica??''}</td>
      <td>${i.DescricaoProduto??''}</td>
      <td>${i.NomeFornecedor??''}</td>
      <td>${i.UnidadeMedida??''}</td>
      <td>${i.SaldoAtual??0}</td>
      <td>${new Date(i.DataAtualizacao||i.Modified).toLocaleString('pt-BR')}</td>`;
    tbody.appendChild(tr);
  });
  $('#loaderSaldo').classList.add('hidden');
  $('#tableSaldo').classList.remove('hidden');
}
function setActiveTab(id) {
  $$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.target===id));
  ['tab-produtos','tab-entradas','tab-saidas','tab-saldo']
    .forEach(sec=>$('#'+sec).classList.toggle('hidden',sec!==id));
}
$$('.tab').forEach(t=>t.addEventListener('click',()=>setActiveTab(t.dataset.target)));
$('#btnExportSaldo').addEventListener('click',()=>{
  const rows=[...document.querySelectorAll('#tableSaldo tr')].map(tr=>[...tr.cells].map(td=>`"${td.innerText}"`).join(','));
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`Saldo_${new Date().toISOString().split('T')[0]}.csv`;a.click();
});
$('#btnRecarregar').addEventListener('click',loadProdutos);
$('#btnAbrirFormEntrada').addEventListener('click',()=>window.open(FORM_URL_ENTRADA,'_blank'));
$('#btnAbrirFormSaida').addEventListener('click',()=>window.open(FORM_URL_SAIDA,'_blank'));
loadProdutos();
</script>
</body>
</html>


