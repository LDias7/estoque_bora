<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Estoque - BORA</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f7fb;margin:0;color:#222}
  header{background:#1f4e8c;color:#fff;padding:16px;text-align:center}
  nav{display:flex;gap:12px;justify-content:center;background:#e6edf5;padding:12px;flex-wrap:wrap}
  button{padding:10px 16px;border:0;border-radius:6px;background:#1f4e8c;color:#fff;font-weight:700;cursor:pointer}
  button:hover{background:#2b6cb0}
  section{display:none;max-width:1100px;margin:18px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  section.active{display:block}
  h2{color:#1f4e8c;margin:0 0 12px}
  label{display:block;margin-top:10px;font-weight:700}
  input,select{width:100%;padding:8px;border:1px solid #cdd7e3;border-radius:6px;box-sizing:border-box}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col-3{flex:1 1 300px}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border:1px solid #d9e2ef;padding:8px;text-align:left;font-size:14px}
  th{background:#f2f6fc}
  .muted{color:#667da0;font-size:13px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .pill{background:#eef4ff;color:#244c8a;border:1px solid #cfe0ff;border-radius:999px;padding:6px 10px;font-size:12px}
  .right{margin-left:auto}
  .filters-row input{width:100%;padding:6px;font-size:12px}
  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .card{background:#f7f9fe;border:1px solid #e5ecf7;border-radius:8px;padding:10px}
  .warn{color:#8a2424}
</style>
</head>
<body>

<header><h1>üì¶ Sistema de Estoque ‚Äì BORA Transportes</h1></header>

<nav>
  <button onclick="mostrar('produtos')">Cadastro de Produtos</button>
  <button onclick="abrirForm('entrada')">Entrada (Form)</button>
  <button onclick="abrirForm('saida')">Sa√≠da (Form)</button>
  <button onclick="mostrar('historico')">Hist√≥rico</button>
  <button onclick="mostrar('saldo')">Saldo</button>
</nav>

<!-- CADASTRO DE PRODUTOS (como estava) -->
<section id="produtos" class="active">
  <h2>üßæ Cadastro de Produtos</h2>
  <p class="muted">Lista: <b>Produtos</b> ‚Äî Campos: T√≠tulo, CodigoFornecedor, DescricaoProduto, NomeFornecedor, UnidadeMedida, SaldoAtual, DataAtualizacao (auto).</p>
  <div class="row">
    <div class="col-3"><label>T√≠tulo (Nome do Produto)</label><input id="pTitle" placeholder="Parafuso M8 x 20mm"></div>
    <div class="col-3"><label>C√≥digo do Fornecedor</label><input id="pCodigoFornecedor" placeholder="CF-12345"></div>
    <div class="col-3"><label>Descri√ß√£o do Produto</label><input id="pDescricao" placeholder="Parafuso zincado sextavado"></div>
    <div class="col-3"><label>Nome do Fornecedor</label><input id="pNomeFornecedor" placeholder="ACME Pe√ßas"></div>
    <div class="col-3"><label>Unidade de Medida</label><input id="pUnidade" placeholder="un, cx, kg, m"></div>
    <div class="col-3"><label>Saldo Atual</label><input id="pSaldoAtual" type="number" step="1" min="0" value="0"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button onclick="salvarProduto()">üíæ Salvar Produto</button>
    <span id="status" class="muted"></span>
  </div>
</section>

<!-- HIST√ìRICO ENTRADAS/SA√çDAS -->
<section id="historico">
  <h2>üìú Hist√≥rico de Entradas e Sa√≠das</h2>

  <div class="toolbar">
    <span class="pill">Entradas</span>
    <input id="filterEntradas" placeholder="Filtrar (t√≠tulo/nota fiscal)..." style="max-width:320px">
    <button onclick="carregarEntradas()">Recarregar</button>
  </div>
  <table id="tableEntradas">
    <thead>
      <tr>
        <th>T√≠tulo</th><th>Quantidade</th><th>Valor Unit√°rio</th><th>Valor Total</th><th>Nota Fiscal</th><th>Atualiza√ß√£o</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="toolbar" style="margin-top:18px">
    <span class="pill">Sa√≠das</span>
    <input id="filterSaidas" placeholder="Filtrar (t√≠tulo/destinat√°rio/placa)..." style="max-width:360px">
    <button onclick="carregarSaidas()">Recarregar</button>
  </div>
  <table id="tableSaidas">
    <thead>
      <tr>
        <th>T√≠tulo</th><th>Descri√ß√£o Produto</th><th>Quantidade</th><th>Placa Caminh√£o</th><th>Destinat√°rio</th><th>Atualiza√ß√£o</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- SALDO (com filtros tipo planilha e resumo por item) -->
<section id="saldo">
  <h2>üìä Saldo de Produtos</h2>
  <div class="toolbar">
    <button onclick="carregarProdutos()">üîÑ Recarregar</button>
    <button onclick="exportarCSV()">‚¨áÔ∏è Exportar CSV</button>
    <span class="right muted" id="saldoInfo">‚Äî</span>
  </div>
  <table id="tableSaldo">
    <thead>
      <tr>
        <th>T√≠tulo</th>
        <th>C√≥digo Fornecedor</th>
        <th>Descri√ß√£o Produto</th>
        <th>Nome Fornecedor</th>
        <th>Unidade</th>
        <th>Saldo Atual</th>
        <th>Data Atualiza√ß√£o</th>
      </tr>
      <!-- Linha de filtros por coluna (estilo planilha) -->
      <tr class="filters-row">
        <th><input data-col="Title" placeholder="Filtrar t√≠tulo"></th>
        <th><input data-col="CodigoFornecedor" placeholder="Filtrar c√≥d. fornecedor"></th>
        <th><input data-col="DescricaoProduto" placeholder="Filtrar descri√ß√£o"></th>
        <th><input data-col="NomeFornecedor" placeholder="Filtrar fornecedor"></th>
        <th><input data-col="UnidadeMedida" placeholder="Filtrar unidade"></th>
        <th><input data-col="SaldoAtual" placeholder="=, >, < (ex. >10)"></th>
        <th><input data-col="DataAtualizacao" placeholder="aaaa-mm-dd"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 style="margin-top:18px">üìà Resumo por Item (soma do SaldoAtual por T√≠tulo)</h3>
  <div id="resumoWrap" class="cards"></div>
</section>

<script>
/* ========= CONFIG ========= */
const SITE = "https://borexpress.sharepoint.com/sites/EstoqueJC";
const LIST_PRODUTOS = "Produtos";
const LIST_ENTRADAS = "Entradas";
const LIST_SAIDAS   = "Saidas";

// Forms fornecidos
const FORM_ENTRADA = "https://forms.microsoft.com/r/8EaCX7pKRQ";
const FORM_SAIDA   = "https://forms.microsoft.com/r/n2Rr51aG6s";
const FORM_CAD     = "https://forms.microsoft.com/r/cYKFvRQbRV"; // (n√£o utilizado na UI, mas deixei aqui)

/* ========= LAYOUT CL√ÅSSICO ========= */
function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==='historico'){carregarEntradas();carregarSaidas();}
  if(id==='saldo'){carregarProdutos();}
}
function abrirForm(tipo){
  if(tipo==='entrada') window.open(FORM_ENTRADA,'_blank','noopener');
  if(tipo==='saida')   window.open(FORM_SAIDA,'_blank','noopener');
}

/* ========= HELPERS ========= */
const fmtBR = (n,dec=2)=>Number(n).toLocaleString('pt-BR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
function toDateStr(d){try{if(!d) return ""; const x=new Date(d); if(isNaN(x)) return ""; return x.toLocaleString('pt-BR')}catch{return ""}}

async function spGet(list, select, orderby, top=5000){
  const qs = [
    `$select=${encodeURIComponent(select)}`,
    orderby?`$orderby=${encodeURIComponent(orderby)}`:"",
    `$top=${top}`
  ].filter(Boolean).join("&");
  const r = await fetch(`${SITE}/_api/web/lists/GetByTitle('${list}')/items?${qs}`, { headers:{Accept:'application/json;odata=nometadata'} });
  if(!r.ok){ throw new Error(`GET ${list} ${r.status}`); }
  const j = await r.json(); return j.value||[];
}
async function spDigest(){
  const r=await fetch(`${SITE}/_api/contextinfo`,{method:'POST',headers:{Accept:'application/json;odata=nometadata'}});
  if(!r.ok) throw new Error('Digest falhou');
  return (await r.json()).FormDigestValue;
}
async function spPost(list, obj){
  const digest = await spDigest();
  const r = await fetch(`${SITE}/_api/web/lists/GetByTitle('${list}')/items`, {
    method:'POST',
    headers:{
      'Accept':'application/json;odata=nometadata',
      'Content-Type':'application/json;odata=nometadata',
      'X-RequestDigest':digest
    },
    body:JSON.stringify(obj)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

/* ========= CADASTRO (como estava) ========= */
async function salvarProduto(){
  const Title = document.getElementById('pTitle').value.trim();
  if(!Title){ return statusMsg('Preencha o T√≠tulo.', true); }
  const obj = {
    Title,
    CodigoFornecedor: document.getElementById('pCodigoFornecedor').value.trim(),
    DescricaoProduto: document.getElementById('pDescricao').value.trim(),
    NomeFornecedor:   document.getElementById('pNomeFornecedor').value.trim(),
    UnidadeMedida:    document.getElementById('pUnidade').value.trim(),
    SaldoAtual:       Number(document.getElementById('pSaldoAtual').value || 0),
    DataAtualizacao:  new Date().toISOString()
  };
  try{
    statusMsg('Salvando...');
    await spPost(LIST_PRODUTOS, obj);
    statusMsg('‚úÖ Produto salvo com sucesso!');
    // limpa
    ['pTitle','pCodigoFornecedor','pDescricao','pNomeFornecedor','pUnidade','pSaldoAtual'].forEach(id=>document.getElementById(id).value = id==='pSaldoAtual' ? 0 : '');
  }catch(e){
    statusMsg('‚ùå Erro: '+e.message, true);
  }
}
function statusMsg(t, warn=false){ const el=document.getElementById('status'); el.textContent=t; el.classList.toggle('warn', !!warn); }

/* ========= HIST√ìRICO ========= */
let ENTRADAS_CACHE=[], SAIDAS_CACHE=[];
async function carregarEntradas(){
  const data = await spGet(LIST_ENTRADAS, "Title,Quantidade,ValorUnitario,ValorTotal,NotaFiscal,Modified", "Modified desc", 2000);
  ENTRADAS_CACHE = data;
  renderEntradas();
}
function renderEntradas(){
  const term = (document.getElementById('filterEntradas').value||'').toLowerCase().trim();
  const tb = document.querySelector("#tableEntradas tbody"); tb.innerHTML="";
  ENTRADAS_CACHE
    .filter(x => !term || (x.Title||'').toLowerCase().includes(term) || (x.NotaFiscal||'').toLowerCase().includes(term))
    .forEach(i=>{
      const q = Number(i.Quantidade)||0;
      const vu = Number(i.ValorUnitario)||0;
      const vt = (i.ValorTotal!==null && i.ValorTotal!==undefined && i.ValorTotal!=="") ? Number(i.ValorTotal) : (q*vu);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i.Title||''}</td>
        <td>${q}</td>
        <td>R$ ${fmtBR(vu)}</td>
        <td>R$ ${fmtBR(vt)}</td>
        <td>${i.NotaFiscal||''}</td>
        <td>${toDateStr(i.Modified)}</td>`;
      tb.appendChild(tr);
    });
}
document.getElementById('filterEntradas').addEventListener('input', debounce(renderEntradas, 200));

async function carregarSaidas(){
  const data = await spGet(LIST_SAIDAS, "Title,DescricaoProduto,Quantidade,PlacaCaminhao,Destinatario,Modified", "Modified desc", 2000);
  SAIDAS_CACHE = data;
  renderSaidas();
}
function renderSaidas(){
  const term = (document.getElementById('filterSaidas').value||'').toLowerCase().trim();
  const tb = document.querySelector("#tableSaidas tbody"); tb.innerHTML="";
  SAIDAS_CACHE
    .filter(x => !term || (x.Title||'').toLowerCase().includes(term) || (x.Destinatario||'').toLowerCase().includes(term) || (x.PlacaCaminhao||'').toLowerCase().includes(term))
    .forEach(i=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i.Title||''}</td>
        <td>${i.DescricaoProduto||''}</td>
        <td>${i.Quantidade||0}</td>
        <td>${i.PlacaCaminhao||''}</td>
        <td>${i.Destinatario||''}</td>
        <td>${toDateStr(i.Modified)}</td>`;
      tb.appendChild(tr);
    });
}
document.getElementById('filterSaidas').addEventListener('input', debounce(renderSaidas, 200));

/* ========= SALDO (filtros tipo planilha + resumo) ========= */
let PRODUTOS_CACHE=[], PRODUTOS_FILTRADO=[];
async function carregarProdutos(){
  const data = await spGet(LIST_PRODUTOS, "Title,CodigoFornecedor,DescricaoProduto,NomeFornecedor,UnidadeMedida,SaldoAtual,DataAtualizacao,Modified", "Title asc", 5000);
  PRODUTOS_CACHE = data;
  aplicarFiltrosSaldo(); // render com filtros
}
function aplicarFiltrosSaldo(){
  // l√™ filtros
  const f = {};
  document.querySelectorAll('.filters-row input').forEach(inp=>f[inp.dataset.col]=inp.value.trim());

  PRODUTOS_FILTRADO = PRODUTOS_CACHE.filter(it=>{
    // texto cont√©m
    const like = (v,term)=> !term || (String(v||'').toLowerCase().includes(term.toLowerCase()));
    if(!like(it.Title, f.Title)) return false;
    if(!like(it.CodigoFornecedor, f.CodigoFornecedor)) return false;
    if(!like(it.DescricaoProduto, f.DescricaoProduto)) return false;
    if(!like(it.NomeFornecedor, f.NomeFornecedor)) return false;
    if(!like(it.UnidadeMedida, f.UnidadeMedida)) return false;

    // n√∫mero: suporta =, >, < (ex: >10)
    if(f.SaldoAtual){
      const m = f.SaldoAtual.match(/^\s*([<>]=?|=)?\s*(-?\d+(?:\.\d+)?)\s*$/);
      const val = Number(it.SaldoAtual||0);
      if(m){
        const op = m[1]||'=';
        const tgt = Number(m[2]);
        if(op==='=' && !(val===tgt)) return false;
        if(op==='>' && !(val>tgt)) return false;
        if(op==='<' && !(val<tgt)) return false;
        if(op==='>=' && !(val>=tgt)) return false;
        if(op==='<=' && !(val<=tgt)) return false;
      }
    }

    // data (aaaa-mm-dd)
    if(f.DataAtualizacao){
      const d = new Date(it.DataAtualizacao || it.Modified);
      const ymd = d.toISOString().slice(0,10);
      if(!ymd.startsWith(f.DataAtualizacao)) return false;
    }
    return true;
  });

  renderSaldo(PRODUTOS_FILTRADO);
  renderResumo(PRODUTOS_FILTRADO);
}
function renderSaldo(rows){
  const tb = document.querySelector("#tableSaldo tbody"); tb.innerHTML="";
  rows.forEach(i=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i.Title||''}</td>
      <td>${i.CodigoFornecedor||''}</td>
      <td>${i.DescricaoProduto||''}</td>
      <td>${i.NomeFornecedor||''}</td>
      <td>${i.UnidadeMedida||''}</td>
      <td>${Number(i.SaldoAtual||0)}</td>
      <td>${toDateStr(i.DataAtualizacao||i.Modified)}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('saldoInfo').textContent =
    `Itens: ${rows.length} | Saldo total: ${fmtBR(rows.reduce((s,x)=>s+Number(x.SaldoAtual||0),0),0)}`;
}
function renderResumo(rows){
  // soma por T√≠tulo
  const map = new Map();
  rows.forEach(i=>{
    const key = i.Title||'(sem t√≠tulo)';
    const val = Number(i.SaldoAtual||0);
    map.set(key, (map.get(key)||0)+val);
  });
  const wrap = document.getElementById('resumoWrap'); wrap.innerHTML="";
  [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0],'pt-BR')).forEach(([title,total])=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<div><b>${title}</b></div><div class="muted">Saldo: <b>${fmtBR(total,0)}</b></div>`;
    wrap.appendChild(div);
  });
}
// liga filtros
document.querySelectorAll('.filters-row input').forEach(inp=>{
  inp.addEventListener('input', debounce(aplicarFiltrosSaldo, 180));
});

function exportarCSV(){
  const table = document.getElementById('tableSaldo');
  const rows = [...table.rows].map(tr=>[...tr.cells].map(td=>`"${(td.innerText||'').replace(/"/g,'""')}"`).join(','));
  const blob = new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`saldo_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

/* ========= UTILS ========= */
function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(null,a),ms)}}

/* ========= INIT ========= */
(function init(){
  // abre cadastro por padr√£o
  mostrar('produtos');
})();
</script>

</body>
</html>
