<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Estoque ‚Äì BORA</title>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#6b7a90;--text:#e6edf7;
      --primary:#4aa3ff;--accent:#5ee6a8;--danger:#ff6b6b;--radius:16px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      background:radial-gradient(1200px 800px at 10% -10%,#17233b 0%,#0b1220 45%);color:var(--text);margin:0}
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.8);backdrop-filter:blur(6px);border-bottom:1px solid #1f2a44}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 20px}
    .brand{display:flex;gap:12px;align-items:center;font-weight:700}
    .brand .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--primary),var(--accent));color:#0b1220;font-weight:900}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:0;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff}
    .btn-primary{background:linear-gradient(180deg,#2a6ad9,#1e4fb0)}
    .btn-danger{background:linear-gradient(180deg,#b63b3b,#8f2a2a)}
    .btn-accent{background:linear-gradient(180deg,#1f7a5c,#145f47)}
    main{max-width:1100px;margin:18px auto 60px;padding:0 20px}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
    .tab{padding:10px 12px;background:#131c2f;border:1px solid #1f2a44;border-radius:12px;text-align:center;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{background:linear-gradient(180deg,#1a2741,#132038);color:#fff;border-color:#29406e}
    .card{background:linear-gradient(180deg,#121a2b,#0e1525);border:1px solid #1f2a44;border-radius:var(--radius);padding:16px}
    .actions-bar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #223055;background:#0f1729;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:9px 8px;border-bottom:1px solid #1e2a47;text-align:left}
    th{color:#9fb6d9;font-size:14px}
    td{font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none!important}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div>Sistema de Estoque ‚Äì BORA</div>
        <div class="muted">SharePoint + Microsoft Forms</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn-primary" id="btnAbrirFormEntrada">‚ûï Abrir Formul√°rio de ENTRADA</button>
      <button class="btn-danger"  id="btnAbrirFormSaida">‚ûñ Abrir Formul√°rio de SA√çDA</button>
      <button class="btn-accent"  id="btnRecarregar">üîÑ Recarregar Listas</button>
    </div>
  </div>
</header>

<main>
  <!-- ORDEM ORIGINAL MANTIDA -->
  <div class="tabs" id="tabs">
    <div class="tab active" data-target="tab-entradas">Hist√≥rico ‚Äì Entradas</div>
    <div class="tab" data-target="tab-saidas">Hist√≥rico ‚Äì Sa√≠das</div>
    <div class="tab" data-target="tab-saldo">Saldo (Produtos)</div>
    <div class="tab" data-target="tab-produtos">Cadastro ‚Äì Produtos</div>
  </div>

  <!-- ENTRADAS -->
  <section id="tab-entradas" class="card">
    <div class="actions-bar">
      <div>
        <strong>üì• Hist√≥rico de Entradas</strong>
        <div class="muted">Colunas: T√≠tulo, Quantidade, ValorUnit√°rio, ValorTotal, Nota Fiscal (ValorTotal calculado se vier vazio).</div>
      </div>
      <div class="row">
        <input id="filterEntrada" placeholder="Filtrar por t√≠tulo ou nota fiscal..."/>
        <button id="btnFiltroEntrada">Filtrar</button>
      </div>
    </div>
    <div id="loaderEntradas" class="muted">Carregando entradas...</div>
    <table id="tableEntradas" class="hidden">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Quantidade</th>
          <th>Valor Unit√°rio</th>
          <th>Valor Total</th>
          <th>Nota Fiscal</th>
          <th>Atualiza√ß√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- SA√çDAS -->
  <section id="tab-saidas" class="card hidden">
    <div class="actions-bar">
      <div>
        <strong>üì§ Hist√≥rico de Sa√≠das</strong>
        <div class="muted">Colunas: T√≠tulo, Descri√ß√£oProduto, Quantidade, PlacaCaminhao, Destinatario.</div>
      </div>
      <div class="row">
        <input id="filterSaida" placeholder="Filtrar por t√≠tulo/destinat√°rio/placa..."/>
        <button id="btnFiltroSaida">Filtrar</button>
      </div>
    </div>
    <div id="loaderSaidas" class="muted">Carregando sa√≠das...</div>
    <table id="tableSaidas" class="hidden">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Descri√ß√£o do Produto</th>
          <th>Quantidade</th>
          <th>Placa Caminh√£o</th>
          <th>Destinat√°rio</th>
          <th>Atualiza√ß√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- SALDO / PRODUTOS -->
  <section id="tab-saldo" class="card hidden">
    <div class="actions-bar">
      <div>
        <strong>üìä Saldo (Produtos)</strong>
        <div class="muted">Exibe todos os produtos e seus saldos. Exporta√ß√£o em CSV.</div>
      </div>
      <div class="row">
        <input id="filterSaldo" placeholder="Filtrar por t√≠tulo/fornecedor/descri√ß√£o..."/>
        <button id="btnFiltroSaldo">Filtrar</button>
        <button class="btn-accent" id="btnExportSaldo">‚¨áÔ∏è Exportar CSV</button>
      </div>
    </div>
    <div id="loaderSaldo" class="muted">Carregando produtos...</div>
    <table id="tableSaldo" class="hidden">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>C√≥digo Fornecedor</th>
          <th>Descri√ß√£o Produto</th>
          <th>Nome Fornecedor</th>
          <th>Unidade</th>
          <th>Saldo Atual</th>
          <th>Data Atualiza√ß√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CADASTRO ‚Äì PRODUTOS -->
  <section id="tab-produtos" class="card hidden">
    <div class="actions-bar">
      <div>
        <strong>üßæ Cadastro ‚Äì Produtos</strong>
        <div class="muted">Colunas: Title, CodigoFornecedor, DescricaoProduto, NomeFornecedor, UnidadeMedida, SaldoAtual, DataAtualizacao (autom√°tica).</div>
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:10px">
      <div>
        <label>T√≠tulo (Nome do Produto)</label>
        <input id="pTitle" placeholder="Ex.: Parafuso M8 x 20mm"/>
      </div>
      <div>
        <label>C√≥digo do Fornecedor</label>
        <input id="pCodigoFornecedor" placeholder="Ex.: CF-12345"/>
      </div>
      <div>
        <label>Descri√ß√£o do Produto</label>
        <input id="pDescricao" placeholder="Ex.: Parafuso zincado sextavado"/>
      </div>
      <div>
        <label>Nome do Fornecedor</label>
        <input id="pNomeFornecedor" placeholder="Ex.: ACME Pe√ßas"/>
      </div>
      <div>
        <label>Unidade de Medida</label>
        <input id="pUnidade" placeholder="Ex.: un, cx, kg, m"/>
      </div>
      <div>
        <label>Saldo Atual</label>
        <input id="pSaldoAtual" type="number" step="1" min="0" value="0"/>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn-primary" id="btnSalvarProduto">üíæ Salvar Produto</button>
      <div id="saveStatus" class="muted"></div>
    </div>
  </section>
</main>

<script>
/* ===========================
   CONFIG ‚Äì AJUSTE AQUI
=========================== */
const SHAREPOINT_SITE_ROOT = 'https://borexpress.sharepoint.com/sites/EstoqueJC';
const LIST_ENTRADAS = 'Entradas';
const LIST_SAIDAS   = 'Saidas';
const LIST_PRODUTOS = 'Produtos';

// Abrir Forms DIRETO (sem iframe)
const FORM_URL_ENTRADA = 'COLE_AQUI_A_URL_DO_FORM_ENTRADA';
const FORM_URL_SAIDA   = 'COLE_AQUI_A_URL_DO_FORM_SAIDA';

/* ===========================
   HELPERS
=========================== */
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

function fmtNumber(n, opts={minimumFractionDigits:2, maximumFractionDigits:2}){
  const x=Number(n); return isFinite(x)?x.toLocaleString('pt-BR',opts):'';
}
function fmtInt(n){ const x=Number(n); return isFinite(x)?x.toLocaleString('pt-BR',{maximumFractionDigits:0}):''; }
function fmtDate(d){ try{ if(!d) return ''; const dt=new Date(d); if(isNaN(dt)) return ''; return dt.toLocaleString('pt-BR'); }catch{return ''} }

async function spGet(url,select=null,filter=null,orderby=null,top=5000){
  const q=[]; if(select) q.push(`$select=${encodeURIComponent(select)}`);
  if(filter) q.push(`$filter=${encodeURIComponent(filter)}`);
  if(orderby) q.push(`$orderby=${encodeURIComponent(orderby)}`);
  if(top) q.push(`$top=${top}`);
  const qs=q.length?`?${q.join('&')}`:'';
  const r=await fetch(`${SHAREPOINT_SITE_ROOT}${url}${qs}`,{headers:{Accept:'application/json;odata=nometadata'}});
  if(!r.ok) throw new Error(`GET ${url} falhou: ${r.status}`); return r.json();
}

async function spDigest(){
  const r=await fetch(`${SHAREPOINT_SITE_ROOT}/_api/contextinfo`,{method:'POST',headers:{Accept:'application/json;odata=nometadata'}});
  if(!r.ok) throw new Error('Falha ao obter X-RequestDigest'); const j=await r.json(); return j.FormDigestValue;
}

async function spPostItem(listTitle, item){
  // POST direto no SharePoint REST (mantido como antes)
  const digest=await spDigest();
  const url=`${SHAREPOINT_SITE_ROOT}/_api/web/lists/GetByTitle('${encodeURIComponent(listTitle)}')/items`;
  const r=await fetch(url,{
    method:'POST',
    headers:{
      Accept:'application/json;odata=nometadata',
      'Content-Type':'application/json;odata=nometadata',
      'X-RequestDigest':digest
    },
    body:JSON.stringify(item)
  });
  if(!r.ok){ const t=await r.text(); throw new Error(t); }
  return r.json();
}

function exportTableToCSV(tableEl, filename){
  const rows=[...tableEl.rows].map(tr=>[...tr.cells].map(td=>{
    const safe=(td.innerText||'').replace(/"/g,'""'); return `"${safe}"`;
  }).join(','));
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}

/* ===========================
   UI ‚Äì TABS (ordem original)
=========================== */
function setActiveTab(id){
  $$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.target===id));
  ['tab-entradas','tab-saidas','tab-saldo','tab-produtos'].forEach(sec=>{
    const el=document.getElementById(sec);
    el.classList.toggle('hidden',sec!==id);
  });
}
$$('.tab').forEach(t=>t.addEventListener('click',()=>setActiveTab(t.dataset.target)));

/* ===========================
   HEADER BUTTONS
=========================== */
$('#btnAbrirFormEntrada').addEventListener('click',()=>window.open(FORM_URL_ENTRADA,'_blank','noopener'));
$('#btnAbrirFormSaida').addEventListener('click',()=>window.open(FORM_URL_SAIDA,'_blank','noopener'));
$('#btnRecarregar').addEventListener('click',()=>{ loadEntradas(); loadSaidas(); loadProdutos(); });

/* ===========================
   ENTRADAS ‚Äì Hist√≥rico
   Lista: Entradas
   Colunas: Title, Quantidade, ValorUnitario, ValorTotal, NotaFiscal
=========================== */
let ENTRADAS_CACHE=[];
async function loadEntradas(){
  $('#loaderEntradas').classList.remove('hidden'); $('#tableEntradas').classList.add('hidden');
  const select='Id,Title,Quantidade,ValorUnitario,ValorTotal,NotaFiscal,Modified';
  try{
    const data=await spGet(`/_api/web/lists/GetByTitle('${LIST_ENTRADAS}')/items`,select,null,'Modified desc',2000);
    ENTRADAS_CACHE=data.value||[]; renderEntradas(ENTRADAS_CACHE);
  }catch(e){ $('#loaderEntradas').innerText='Erro ao carregar entradas: '+e.message; }
  finally{ $('#loaderEntradas').classList.add('hidden'); }
}
function renderEntradas(rows){
  const tb=$('#tableEntradas tbody'); tb.innerHTML='';
  for(const it of rows){
    const q=Number(it.Quantidade)||0;
    const vu=Number(it.ValorUnitario)||0;
    const vt=(it.ValorTotal!==undefined && it.ValorTotal!==null && it.ValorTotal!=='')? Number(it.ValorTotal):(q*vu);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.Title??''}</td>
      <td>${fmtInt(q)}</td>
      <td>R$ ${fmtNumber(vu)}</td>
      <td>R$ ${fmtNumber(vt)}</td>
      <td>${it.NotaFiscal??''}</td>
      <td>${fmtDate(it.Modified)}</td>
    `;
    tb.appendChild(tr);
  }
  $('#tableEntradas').classList.remove('hidden');
}
$('#btnFiltroEntrada').addEventListener('click',()=>{
  const term=($('#filterEntrada').value||'').toLowerCase().trim();
  if(!term) return renderEntradas(ENTRADAS_CACHE);
  const fil=ENTRADAS_CACHE.filter(it=>
    (it.Title??'').toLowerCase().includes(term) ||
    (it.NotaFiscal??'').toLowerCase().includes(term)
  );
  renderEntradas(fil);
});

/* ===========================
   SA√çDAS ‚Äì Hist√≥rico
   Lista: Saidas
   Colunas: Title, DescricaoProduto, Quantidade, PlacaCaminhao, Destinatario
=========================== */
let SAIDAS_CACHE=[];
async function loadSaidas(){
  $('#loaderSaidas').classList.remove('hidden'); $('#tableSaidas').classList.add('hidden');
  const select='Id,Title,DescricaoProduto,Quantidade,PlacaCaminhao,Destinatario,Modified';
  try{
    const data=await spGet(`/_api/web/lists/GetByTitle('${LIST_SAIDAS}')/items`,select,null,'Modified desc',2000);
    SAIDAS_CACHE=data.value||[]; renderSaidas(SAIDAS_CACHE);
  }catch(e){ $('#loaderSaidas').innerText='Erro ao carregar sa√≠das: '+e.message; }
  finally{ $('#loaderSaidas').classList.add('hidden'); }
}
function renderSaidas(rows){
  const tb=$('#tableSaidas tbody'); tb.innerHTML='';
  for(const it of rows){
    const q=Number(it.Quantidade)||0;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.Title??''}</td>
      <td>${it.DescricaoProduto??''}</td>
      <td>${fmtInt(q)}</td>
      <td>${it.PlacaCaminhao??''}</td>
      <td>${it.Destinatario??''}</td>
      <td>${fmtDate(it.Modified)}</td>
    `;
    tb.appendChild(tr);
  }
  $('#tableSaidas').classList.remove('hidden');
}
$('#btnFiltroSaida').addEventListener('click',()=>{
  const term=($('#filterSaida').value||'').toLowerCase().trim();
  if(!term) return renderSaidas(SAIDAS_CACHE);
  const fil=SAIDAS_CACHE.filter(it=>
    (it.Title??'').toLowerCase().includes(term) ||
    (it.Destinatario??'').toLowerCase().includes(term) ||
    (it.PlacaCaminhao??'').toLowerCase().includes(term)
  );
  renderSaidas(fil);
});

/* ===========================
   SALDO / PRODUTOS ‚Äì Listagem + CSV
   Lista: Produtos
   Colunas: Title, CodigoFornecedor, DescricaoProduto, NomeFornecedor, UnidadeMedida, SaldoAtual, DataAtualizacao
=========================== */
let PRODUTOS_CACHE=[];
async function loadProdutos(){
  $('#loaderSaldo').classList.remove('hidden'); $('#tableSaldo').classList.add('hidden');
  const select='Id,Title,CodigoFornecedor,DescricaoProduto,NomeFornecedor,UnidadeMedida,SaldoAtual,DataAtualizacao,Modified';
  try{
    const data=await spGet(`/_api/web/lists/GetByTitle('${LIST_PRODUTOS}')/items`,select,null,'Title asc',5000);
    PRODUTOS_CACHE=data.value||[]; renderProdutos(PRODUTOS_CACHE);
  }catch(e){ $('#loaderSaldo').innerText='Erro ao carregar produtos: '+e.message; }
  finally{ $('#loaderSaldo').classList.add('hidden'); }
}
function renderProdutos(rows){
  const tb=$('#tableSaldo tbody'); tb.innerHTML='';
  for(const it of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.Title??''}</td>
      <td>${it.CodigoFornecedor??''}</td>
      <td>${it.DescricaoProduto??''}</td>
      <td>${it.NomeFornecedor??''}</td>
      <td>${it.UnidadeMedida??''}</td>
      <td>${fmtInt(it.SaldoAtual??0)}</td>
      <td>${fmtDate(it.DataAtualizacao||it.Modified)}</td>
    `;
    tb.appendChild(tr);
  }
  $('#tableSaldo').classList.remove('hidden');
}
$('#btnFiltroSaldo').addEventListener('click',()=>{
  const term=($('#filterSaldo').value||'').toLowerCase().trim();
  if(!term) return renderProdutos(PRODUTOS_CACHE);
  const fil=PRODUTOS_CACHE.filter(it=>
    (it.Title??'').toLowerCase().includes(term) ||
    (it.CodigoFornecedor??'').toLowerCase().includes(term) ||
    (it.DescricaoProduto??'').toLowerCase().includes(term) ||
    (it.NomeFornecedor??'').toLowerCase().includes(term)
  );
  renderProdutos(fil);
});
$('#btnExportSaldo').addEventListener('click',()=>{
  exportTableToCSV($('#tableSaldo'),`Saldo_Produtos_${new Date().toISOString().slice(0,10)}.csv`);
});

/* ===========================
   CADASTRO ‚Äì PRODUTOS (salva)
=========================== */
async function salvarProduto(){
  const title=$('#pTitle').value.trim();
  if(!title){ $('#saveStatus').innerText='Informe o T√≠tulo.'; return; }

  const item={
    Title:title,
    CodigoFornecedor: $('#pCodigoFornecedor').value.trim(),
    DescricaoProduto: $('#pDescricao').value.trim(),
    NomeFornecedor:   $('#pNomeFornecedor').value.trim(),
    UnidadeMedida:    $('#pUnidade').value.trim(),
    SaldoAtual:       Number($('#pSaldoAtual').value||0),
    DataAtualizacao:  new Date().toISOString()
  };

  try{
    $('#saveStatus').innerText='Salvando...';
    await spPostItem(LIST_PRODUTOS,item);
    $('#saveStatus').innerText='‚úÖ Produto salvo com sucesso.';
    ['#pTitle','#pCodigoFornecedor','#pDescricao','#pNomeFornecedor','#pUnidade','#pSaldoAtual'].forEach(id=>$(id).value='');
    await loadProdutos();
    setActiveTab('tab-saldo');
  }catch(e){
    $('#saveStatus').innerText='‚ùå Erro ao salvar: '+e.message;
  }
}
$('#btnSalvarProduto').addEventListener('click',salvarProduto);

/* ===========================
   INIT
=========================== */
async function init(){
  setActiveTab('tab-entradas');
  await Promise.all([loadEntradas(),loadSaidas(),loadProdutos()]);
}
init();
</script>
</body>
</html>
