<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Estoque - BORA Transportes</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f7fb;margin:0;color:#222}
  header{background:#1f4e8c;color:#fff;padding:16px;text-align:center}
  nav{display:flex;gap:12px;justify-content:center;background:#e6edf5;padding:12px;flex-wrap:wrap}
  button{padding:10px 16px;border:0;border-radius:6px;background:#1f4e8c;color:#fff;font-weight:700;cursor:pointer}
  button:hover{background:#2b6cb0}
  section{display:none;max-width:1100px;margin:18px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  section.active{display:block}
  h2{color:#1f4e8c;margin:0 0 12px}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border:1px solid #d9e2ef;padding:8px;text-align:left;font-size:14px}
  th{background:#f2f6fc}
  .muted{color:#667da0;font-size:13px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .right{margin-left:auto}
  .filters-row input{width:100%;padding:6px;font-size:12px}
  .btn-exportar{background-color:#0078d4;color:white;border:none;padding:8px 14px;border-radius:6px;font-weight:bold;cursor:pointer}
  .btn-exportar:hover{background-color:#005a9e}
</style>
</head>
<body>

<header><h1>üì¶ Sistema de Estoque ‚Äì BORA Transportes</h1></header>

<nav>
  <button onclick="abrirForm('cadastro')">Cadastro (Form)</button>
  <button onclick="abrirForm('entrada')">Entrada (Form)</button>
  <button onclick="abrirForm('saida')">Sa√≠da (Form)</button>
  <button onclick="mostrar('historico')">Hist√≥rico</button>
  <button onclick="mostrar('saldo')">Saldo</button>
</nav>

<!-- HOME LIMPA -->
<section id="home" class="active"></section>

<!-- HIST√ìRICO COM SELETOR -->
<section id="historico">
  <h2>üìú Hist√≥rico</h2>
  <div class="toolbar">
    <label for="tipoHistorico"><b>Selecionar:</b></label>
    <select id="tipoHistorico" onchange="mudarHistorico()">
      <option value="entrada">Entradas</option>
      <option value="saida">Sa√≠das</option>
    </select>
    <button onclick="recarregarHistorico()">üîÑ Recarregar</button>
    <input id="filtroHistorico" placeholder="Filtrar..." style="flex:1;max-width:300px">
    <span class="muted right" id="infoHistorico">‚Äî</span>
  </div>

  <table id="tabelaHistorico">
    <thead></thead>
    <tbody></tbody>
  </table>
</section>

<!-- SALDO -->
<section id="saldo">
  <h2>üìä Saldo de Produtos</h2>
  <div class="toolbar">
    <button onclick="carregarProdutos()">üîÑ Recarregar</button>
    <button class="btn-exportar" onclick="exportarCSV()">‚¨áÔ∏è Exportar Planilha</button>
    <span id="saldoInfo" class="muted right">‚Äî</span>
  </div>
  <table id="tableSaldo">
    <thead>
      <tr>
        <th>T√≠tulo</th>
        <th>C√≥digo Fornecedor</th>
        <th>Descri√ß√£o Produto</th>
        <th>Nome Fornecedor</th>
        <th>Unidade</th>
        <th>Saldo Atual</th>
        <th>Data Atualiza√ß√£o</th>
      </tr>
      <tr class="filters-row">
        <th><input data-col="Title" placeholder="Filtrar t√≠tulo"></th>
        <th><input data-col="CodigoFornecedor" placeholder="Filtrar c√≥d. fornecedor"></th>
        <th><input data-col="DescricaoProduto" placeholder="Filtrar descri√ß√£o"></th>
        <th><input data-col="NomeFornecedor" placeholder="Filtrar fornecedor"></th>
        <th><input data-col="UnidadeMedida" placeholder="Filtrar unidade"></th>
        <th><input data-col="SaldoAtual" placeholder="=, >, < (ex. >10)"></th>
        <th><input data-col="DataAtualizacao" placeholder="aaaa-mm-dd"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
/* CONFIGURA√á√ÉO */
const FORM_CAD = "https://forms.microsoft.com/r/cYKFvRQbRV";
const FORM_ENTRADA = "https://forms.microsoft.com/r/8EaCX7pKRQ";
const FORM_SAIDA = "https://forms.microsoft.com/r/n2Rr51aG6s";

const CSV_URL_ENTRADAS = "https://borexpress.sharepoint.com/:x:/r/sites/EstoqueJC/_layouts/15/Doc.aspx?sourcedoc=%7B9E196987-794A-4F5D-9E9A-30A4B2399843%7D&file=Entradas.xlsx&action=default&mobileredirect=true"; 
const CSV_URL_SAIDAS = "https://borexpress.sharepoint.com/:x:/r/sites/EstoqueJC/_layouts/15/Doc.aspx?sourcedoc=%7B45A6FF48-01FE-43D0-9D9C-2089BBD49A74%7D&file=Sa%C3%ADdas.xlsx&action=default&mobileredirect=true";   
const CSV_URL_PRODUTOS = "https://borexpress.sharepoint.com/:x:/r/sites/EstoqueJC/_layouts/15/Doc.aspx?sourcedoc=%7BE60CFD50-65D1-4A1F-90D7-D244669002D9%7D&file=Produtos.xlsx&action=default&mobileredirect=true"; 
const USE_MOCK = !CSV_URL_ENTRADAS || !CSV_URL_SAIDAS || !CSV_URL_PRODUTOS;

/* LAYOUT */
function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==='historico') mudarHistorico();
  if(id==='saldo') carregarProdutos();
}
function abrirForm(tipo){
  if(tipo==='cadastro') window.open(FORM_CAD,'_blank','noopener');
  if(tipo==='entrada') window.open(FORM_ENTRADA,'_blank','noopener');
  if(tipo==='saida') window.open(FORM_SAIDA,'_blank','noopener');
}

/* CSV UTILS */
async function fetchCSV(url){ const r=await fetch(url,{cache:'no-store'}); return await r.text();}
function parseCSV(text){ const l=text.trim().split('\n'); const h=l[0].split(','); return l.slice(1).map(row=>{const c=row.split(',');const o={};h.forEach((x,i)=>o[x]=c[i]);return o;});}
function num(x){return Number(x)||0;}
const fmtBR = n => Number(n).toLocaleString('pt-BR',{maximumFractionDigits:2});

/* MOCK */
const MOCK_ENTRADAS=[{Title:"Parafuso",Quantidade:"10",ValorUnitario:"2",ValorTotal:"20",NotaFiscal:"NF01",Modified:"2025-10-10"}];
const MOCK_SAIDAS=[{Title:"Arruela",DescricaoProduto:"Arruela A√ßo",Quantidade:"5",PlacaCaminhao:"ABC1234",Destinatario:"Cliente Z",Modified:"2025-10-11"}];
const MOCK_PRODUTOS=[{Title:"Parafuso",CodigoFornecedor:"CF01",DescricaoProduto:"Parafuso M8",NomeFornecedor:"ACME",UnidadeMedida:"un",SaldoAtual:"200",DataAtualizacao:"2025-10-11"}];

/* HIST√ìRICO */
let HIST_CACHE=[];
async function mudarHistorico(){ 
  const tipo=document.getElementById('tipoHistorico').value;
  const th=document.querySelector('#tabelaHistorico thead'); const tb=document.querySelector('#tabelaHistorico tbody');
  th.innerHTML=""; tb.innerHTML="";
  if(tipo==='entrada'){
    th.innerHTML="<tr><th>T√≠tulo</th><th>Quantidade</th><th>Valor Unit√°rio</th><th>Valor Total</th><th>Nota Fiscal</th><th>Atualiza√ß√£o</th></tr>";
    carregarHistorico('entrada');
  } else {
    th.innerHTML="<tr><th>T√≠tulo</th><th>Descri√ß√£o Produto</th><th>Quantidade</th><th>Placa Caminh√£o</th><th>Destinat√°rio</th><th>Atualiza√ß√£o</th></tr>";
    carregarHistorico('saida');
  }
}
async function carregarHistorico(tipo){
  const url = tipo==='entrada'?CSV_URL_ENTRADAS:CSV_URL_SAIDAS;
  try{
    if(USE_MOCK){HIST_CACHE = tipo==='entrada'?MOCK_ENTRADAS:MOCK_SAIDAS;}
    else {const csv=await fetchCSV(url); HIST_CACHE=parseCSV(csv);}
    renderHistorico(tipo);
  }catch(e){document.getElementById('infoHistorico').textContent='Erro: '+e.message;}
}
function renderHistorico(tipo){
  const tb=document.querySelector('#tabelaHistorico tbody'); tb.innerHTML="";
  const f=document.getElementById('filtroHistorico').value.toLowerCase();
  let count=0;
  HIST_CACHE.filter(r=>!f || Object.values(r).some(v=>String(v).toLowerCase().includes(f)))
  .forEach(i=>{
    const tr=document.createElement('tr');
    if(tipo==='entrada') tr.innerHTML=`<td>${i.Title}</td><td>${i.Quantidade}</td><td>${i.ValorUnitario}</td><td>${i.ValorTotal}</td><td>${i.NotaFiscal}</td><td>${i.Modified}</td>`;
    else tr.innerHTML=`<td>${i.Title}</td><td>${i.DescricaoProduto}</td><td>${i.Quantidade}</td><td>${i.PlacaCaminhao}</td><td>${i.Destinatario}</td><td>${i.Modified}</td>`;
    tb.appendChild(tr); count++;
  });
  document.getElementById('infoHistorico').textContent=`Registros: ${count}`;
}
function recarregarHistorico(){mudarHistorico();}
document.getElementById('filtroHistorico').addEventListener('input',()=>mudarHistorico());

/* SALDO */
let PROD_CACHE=[];
async function carregarProdutos(){
  try{
    if(USE_MOCK){PROD_CACHE=MOCK_PRODUTOS;}
    else{const csv=await fetchCSV(CSV_URL_PRODUTOS);PROD_CACHE=parseCSV(csv);}
    renderSaldo(PROD_CACHE);
  }catch(e){document.getElementById('saldoInfo').textContent='Erro: '+e.message;}
}
function renderSaldo(rows){
  const tb=document.querySelector('#tableSaldo tbody'); tb.innerHTML="";
  rows.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.Title}</td><td>${i.CodigoFornecedor}</td><td>${i.DescricaoProduto}</td><td>${i.NomeFornecedor}</td><td>${i.UnidadeMedida}</td><td>${fmtBR(i.SaldoAtual)}</td><td>${i.DataAtualizacao}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('saldoInfo').textContent=`Itens: ${rows.length}`;
}
function exportarCSV(){
  const table=document.getElementById('tableSaldo');
  const rows=[...table.rows].map(tr=>[...tr.cells].map(td=>`"${(td.innerText||'').replace(/"/g,'""')}"`).join(','));
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`produtos_${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

(function init(){mostrar('home');})();
</script>

</body>
</html>
