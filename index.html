<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Estoque - BORA</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f3f6fb;
  margin: 0;
  padding: 0;
  color: #333;
}
header {
  background-color: #1f4e8c;
  color: white;
  padding: 15px;
  text-align: center;
}
nav {
  display: flex;
  justify-content: center;
  gap: 15px;
  background-color: #e2e8f0;
  padding: 15px;
}
button {
  padding: 10px 20px;
  border: none;
  background-color: #1f4e8c;
  color: white;
  cursor: pointer;
  border-radius: 6px;
  font-weight: bold;
}
button:hover { background-color: #2b6cb0; }
section { display: none; padding: 20px; max-width: 1000px; margin: auto; background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
section.active { display: block; }
h2 { color: #1f4e8c; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f0f0f0; }
input { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
#status { color: #1f4e8c; font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>

<header><h1>üì¶ Sistema de Estoque ‚Äì BORA Transportes</h1></header>

<nav>
  <button onclick="mostrar('produtos')">Cadastro de Produtos</button>
  <button onclick="abrirForm('entrada')">Entrada</button>
  <button onclick="abrirForm('saida')">Sa√≠da</button>
  <button onclick="mostrar('historico')">Hist√≥rico</button>
  <button onclick="mostrar('saldo')">Saldo</button>
</nav>

<!-- CADASTRO DE PRODUTOS -->
<section id="produtos" class="active">
  <h2>Cadastro de Produtos</h2>
  <label>T√≠tulo:</label><input id="pTitle">
  <label>C√≥digo do Fornecedor:</label><input id="pCodigoFornecedor">
  <label>Descri√ß√£o do Produto:</label><input id="pDescricao">
  <label>Nome do Fornecedor:</label><input id="pNomeFornecedor">
  <label>Unidade de Medida:</label><input id="pUnidade">
  <label>Saldo Atual:</label><input id="pSaldoAtual" type="number" value="0">
  <button onclick="salvarProduto()">üíæ Salvar Produto</button>
  <p id="status"></p>
</section>

<!-- HIST√ìRICO -->
<section id="historico">
  <h2>üìú Hist√≥rico de Entradas e Sa√≠das</h2>

  <h3>Entradas</h3>
  <table id="tableEntradas">
    <thead>
      <tr><th>T√≠tulo</th><th>Quantidade</th><th>Valor Unit√°rio</th><th>Valor Total</th><th>Nota Fiscal</th><th>Atualiza√ß√£o</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Sa√≠das</h3>
  <table id="tableSaidas">
    <thead>
      <tr><th>T√≠tulo</th><th>Descri√ß√£o</th><th>Quantidade</th><th>Placa Caminh√£o</th><th>Destinat√°rio</th><th>Atualiza√ß√£o</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- SALDO -->
<section id="saldo">
  <h2>üìä Saldo Atual de Produtos</h2>
  <button onclick="exportarCSV()">‚¨áÔ∏è Exportar para CSV</button>
  <table id="tableSaldo">
    <thead>
      <tr><th>T√≠tulo</th><th>C√≥digo Fornecedor</th><th>Descri√ß√£o</th><th>Nome Fornecedor</th><th>Unidade</th><th>Saldo Atual</th><th>Data Atualiza√ß√£o</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
const SITE = "https://borexpress.sharepoint.com/sites/EstoqueJC";
const LIST_PRODUTOS = "Produtos";
const LIST_ENTRADAS = "Entradas";
const LIST_SAIDAS   = "Saidas";
const FORM_ENTRADA = "COLE_AQUI_A_URL_DO_FORM_ENTRADA";
const FORM_SAIDA   = "COLE_AQUI_A_URL_DO_FORM_SAIDA";

function mostrar(id){
  document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==='historico'){carregarEntradas();carregarSaidas();}
  if(id==='saldo'){carregarProdutos();}
}
function abrirForm(tipo){
  if(tipo==='entrada') window.open(FORM_ENTRADA,'_blank');
  if(tipo==='saida') window.open(FORM_SAIDA,'_blank');
}

// Helper
async function spGet(list, select){
  const r = await fetch(`${SITE}/_api/web/lists/GetByTitle('${list}')/items?$select=${select}&$top=5000`,{headers:{Accept:'application/json;odata=nometadata'}});
  const j = await r.json();
  return j.value || [];
}
async function spDigest(){
  const r = await fetch(`${SITE}/_api/contextinfo`,{method:'POST',headers:{Accept:'application/json;odata=nometadata'}});
  const j = await r.json();
  return j.FormDigestValue;
}
async function spPost(list, data){
  const digest = await spDigest();
  const r = await fetch(`${SITE}/_api/web/lists/GetByTitle('${list}')/items`,{
    method:'POST',
    headers:{
      'Accept':'application/json;odata=nometadata',
      'Content-Type':'application/json;odata=nometadata',
      'X-RequestDigest':digest
    },
    body:JSON.stringify(data)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

// CADASTRO PRODUTO
async function salvarProduto(){
  const obj={
    Title:document.getElementById('pTitle').value.trim(),
    CodigoFornecedor:document.getElementById('pCodigoFornecedor').value.trim(),
    DescricaoProduto:document.getElementById('pDescricao').value.trim(),
    NomeFornecedor:document.getElementById('pNomeFornecedor').value.trim(),
    UnidadeMedida:document.getElementById('pUnidade').value.trim(),
    SaldoAtual:Number(document.getElementById('pSaldoAtual').value||0),
    DataAtualizacao:new Date().toISOString()
  };
  if(!obj.Title){document.getElementById('status').textContent="Preencha o t√≠tulo";return;}
  document.getElementById('status').textContent="Salvando...";
  try{
    await spPost(LIST_PRODUTOS,obj);
    document.getElementById('status').textContent="‚úÖ Produto salvo com sucesso!";
  }catch(e){
    document.getElementById('status').textContent="‚ùå Erro: "+e.message;
  }
}

// HIST√ìRICO ENTRADAS
async function carregarEntradas(){
  const t=document.querySelector("#tableEntradas tbody");
  t.innerHTML="";
  const data=await spGet(LIST_ENTRADAS,"Title,Quantidade,ValorUnitario,ValorTotal,NotaFiscal,Modified");
  data.forEach(i=>{
    const q=Number(i.Quantidade)||0;
    const vu=Number(i.ValorUnitario)||0;
    const vt=i.ValorTotal!==null?Number(i.ValorTotal):q*vu;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.Title||''}</td><td>${q}</td><td>R$ ${vu.toFixed(2)}</td><td>R$ ${vt.toFixed(2)}</td><td>${i.NotaFiscal||''}</td><td>${new Date(i.Modified).toLocaleString('pt-BR')}</td>`;
    t.appendChild(tr);
  });
}
// HIST√ìRICO SAIDAS
async function carregarSaidas(){
  const t=document.querySelector("#tableSaidas tbody");
  t.innerHTML="";
  const data=await spGet(LIST_SAIDAS,"Title,DescricaoProduto,Quantidade,PlacaCaminhao,Destinatario,Modified");
  data.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.Title||''}</td><td>${i.DescricaoProduto||''}</td><td>${i.Quantidade||0}</td><td>${i.PlacaCaminhao||''}</td><td>${i.Destinatario||''}</td><td>${new Date(i.Modified).toLocaleString('pt-BR')}</td>`;
    t.appendChild(tr);
  });
}

// SALDO
async function carregarProdutos(){
  const t=document.querySelector("#tableSaldo tbody");
  t.innerHTML="";
  const data=await spGet(LIST_PRODUTOS,"Title,CodigoFornecedor,DescricaoProduto,NomeFornecedor,UnidadeMedida,SaldoAtual,DataAtualizacao,Modified");
  data.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.Title||''}</td><td>${i.CodigoFornecedor||''}</td><td>${i.DescricaoProduto||''}</td><td>${i.NomeFornecedor||''}</td><td>${i.UnidadeMedida||''}</td><td>${i.SaldoAtual||0}</td><td>${new Date(i.DataAtualizacao||i.Modified).toLocaleString('pt-BR')}</td>`;
    t.appendChild(tr);
  });
}
function exportarCSV(){
  const rows=[...document.querySelectorAll("#tableSaldo tr")].map(tr=>[...tr.cells].map(td=>`"${td.innerText}"`).join(","));
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`saldo_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}
</script>

</body>
</html>
