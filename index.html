<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Estoque - BORA Transportes</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f7fb;margin:0;color:#222}
  header{background:#1f4e8c;color:#fff;padding:22px;text-align:center;font-size:22px;font-weight:bold}
  nav{display:flex;gap:20px;justify-content:center;background:#e6edf5;padding:20px;flex-wrap:wrap}
  button{padding:14px 24px;border:0;border-radius:10px;background:#1f4e8c;color:#fff;font-weight:700;cursor:pointer;font-size:18px}
  button:hover{background:#2b6cb0}
  section{display:none;max-width:1200px;margin:30px auto;background:#fff;padding:28px;border-radius:12px;box-shadow:0 3px 12px rgba(0,0,0,.08)}
  section.active{display:block}
  h2{color:#1f4e8c;margin:0 0 20px;font-size:28px}
  table{width:100%;border-collapse:collapse;margin-top:18px;font-size:17px}
  th,td{border:1px solid #d9e2ef;padding:10px;text-align:left}
  th{background:#f2f6fc}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .right{margin-left:auto}
  .btn-exportar{background-color:#0078d4;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px}
  .btn-exportar:hover{background-color:#005a9e}
  .btn-voltar{background:#999;color:#fff;padding:10px 18px;border:0;border-radius:8px;font-weight:bold;font-size:16px;cursor:pointer}
  .btn-voltar:hover{background:#777}
  /* tela inicial */
  #home{display:flex;flex-direction:column;align-items:center;justify-content:center;height:70vh;background:#f7faff;box-shadow:none}
  #home button{font-size:22px;padding:18px 40px;margin:10px;border-radius:12px}
  #resumoSaldo{font-size:18px;margin-bottom:10px;font-weight:bold;color:#1f4e8c}
</style>
</head>
<body>

<header>Sistema de Estoque – BORA Transportes</header>

<nav>
  <button onclick="mostrar('home')">Início</button>
  <button onclick="abrirForm('cadastro')">Cadastro</button>
  <button onclick="abrirForm('entrada')">Entrada</button>
  <button onclick="abrirForm('saida')">Saída</button>
  <button onclick="mostrar('historico')">Histórico</button>
  <button onclick="mostrar('saldo')">Saldo</button>
</nav>

<!-- TELA INICIAL -->
<section id="home" class="active">
  <button onclick="abrirForm('cadastro')">Cadastro de Produtos</button>
  <button onclick="abrirForm('entrada')">Entrada de Materiais</button>
  <button onclick="abrirForm('saida')">Saída de Materiais</button>
  <button onclick="mostrar('historico')">Histórico</button>
  <button onclick="mostrar('saldo')">Saldo Atual</button>
</section>

<!-- HISTÓRICO -->
<section id="historico">
  <div class="toolbar">
    <h2>Histórico</h2>
    <button class="btn-voltar right" onclick="mostrar('home')">Voltar</button>
  </div>

  <div class="toolbar">
    <label for="tipoHistorico"><b>Selecionar:</b></label>
    <select id="tipoHistorico" onchange="mudarHistorico()" style="font-size:16px;padding:6px">
      <option value="entrada">Entradas</option>
      <option value="saida">Saídas</option>
    </select>
    <button onclick="recarregarHistorico()">Recarregar</button>
    <input id="filtroHistorico" placeholder="Filtrar..." style="flex:1;max-width:340px;padding:8px;font-size:15px">
    <span class="right" id="infoHistorico" style="font-size:15px;color:#555">—</span>
  </div>

  <table id="tabelaHistorico">
    <thead></thead>
    <tbody></tbody>
  </table>
</section>

<!-- SALDO -->
<section id="saldo">
  <div class="toolbar">
    <h2>Saldo de Produtos</h2>
    <button class="btn-voltar right" onclick="mostrar('home')">Voltar</button>
  </div>

  <div id="resumoSaldo">Total de produtos: 0 | Soma total de estoque: 0</div>

  <div class="toolbar">
    <button onclick="carregarProdutos()">Recarregar</button>
    <button class="btn-exportar" onclick="exportarCSV()">Exportar Planilha</button>
    <span id="saldoInfo" class="right" style="font-size:15px;color:#555">—</span>
  </div>

  <table id="tableSaldo">
    <thead>
      <tr>
        <th>Título</th>
        <th>Código Fornecedor</th>
        <th>Descrição Produto</th>
        <th>Nome Fornecedor</th>
        <th>Unidade</th>
        <th>Saldo Atual</th>
        <th>Data Atualização</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
/* CONFIG */
const FORM_CAD="https://forms.microsoft.com/r/cYKFvRQbRV";
const FORM_ENTRADA="https://forms.microsoft.com/r/8EaCX7pKRQ";
const FORM_SAIDA="https://forms.microsoft.com/r/n2Rr51aG6s";
const CSV_URL_ENTRADAS="";
const CSV_URL_SAIDAS="";
const CSV_URL_PRODUTOS="";
const USE_MOCK=!CSV_URL_ENTRADAS||!CSV_URL_SAIDAS||!CSV_URL_PRODUTOS;

/* NAVEGAÇÃO */
function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==='historico') mudarHistorico();
  if(id==='saldo') carregarProdutos();
}
function abrirForm(tipo){
  if(tipo==='cadastro')window.open(FORM_CAD,'_blank','noopener');
  if(tipo==='entrada')window.open(FORM_ENTRADA,'_blank','noopener');
  if(tipo==='saida')window.open(FORM_SAIDA,'_blank','noopener');
}

/* CSV */
async function fetchCSV(url){
  const r=await fetch(url,{cache:'no-store'});
  return await r.text();
}
function parseCSV(t){
  const l=t.trim().split('\n');
  const h=l[0].split(',');
  return l.slice(1).map(r=>{
    const c=r.split(',');
    const o={};
    h.forEach((x,i)=>o[x]=c[i]);
    return o;
  });
}
const fmtBR=n=>Number(n).toLocaleString('pt-BR',{maximumFractionDigits:2});

/* HISTÓRICO */
let HIST_CACHE=[];
async function mudarHistorico(){
  const tipo=document.getElementById('tipoHistorico').value;
  const th=document.querySelector('#tabelaHistorico thead');
  const tb=document.querySelector('#tabelaHistorico tbody');
  th.innerHTML="";tb.innerHTML="";
  if(tipo==='entrada'){
    th.innerHTML="<tr><th>Título</th><th>Quantidade</th><th>Valor Unitário</th><th>Valor Total</th><th>Nota Fiscal</th><th>Atualização</th></tr>";
    carregarHistorico('entrada');
  }else{
    th.innerHTML="<tr><th>Título</th><th>Descrição Produto</th><th>Quantidade</th><th>Placa Caminhão</th><th>Destinatário</th><th>Atualização</th></tr>";
    carregarHistorico('saida');
  }
}
async function carregarHistorico(tipo){
  const url=tipo==='entrada'?CSV_URL_ENTRADAS:CSV_URL_SAIDAS;
  try{
    if(USE_MOCK){HIST_CACHE=[];}
    else{const csv=await fetchCSV(url);HIST_CACHE=parseCSV(csv);}
    renderHistorico(tipo);
  }catch(e){
    document.getElementById('infoHistorico').textContent='Erro: '+e.message;
  }
}
function renderHistorico(tipo){
  const tb=document.querySelector('#tabelaHistorico tbody');
  tb.innerHTML="";
  const f=document.getElementById('filtroHistorico').value.toLowerCase();
  let count=0;
  HIST_CACHE.filter(r=>!f||Object.values(r).some(v=>String(v).toLowerCase().includes(f))).forEach(i=>{
    const tr=document.createElement('tr');
    if(tipo==='entrada')
      tr.innerHTML=`<td>${i.Title||''}</td><td>${i.Quantidade||''}</td><td>${i.ValorUnitario||''}</td><td>${i.ValorTotal||''}</td><td>${i.NotaFiscal||''}</td><td>${i.Modified||''}</td>`;
    else
      tr.innerHTML=`<td>${i.Title||''}</td><td>${i.DescricaoProduto||''}</td><td>${i.Quantidade||''}</td><td>${i.PlacaCaminhao||''}</td><td>${i.Destinatario||''}</td><td>${i.Modified||''}</td>`;
    tb.appendChild(tr);
    count++;
  });
  document.getElementById('infoHistorico').textContent=`Registros: ${count}`;
}
function recarregarHistorico(){mudarHistorico();}

/* SALDO */
let PROD_CACHE=[];
async function carregarProdutos(){
  try{
    if(USE_MOCK){PROD_CACHE=[];}
    else{
      const csv=await fetchCSV(CSV_URL_PRODUTOS);
      PROD_CACHE=parseCSV(csv);
    }
    renderSaldo(PROD_CACHE);
  }catch(e){
    document.getElementById('saldoInfo').textContent='Erro: '+e.message;
  }
}
function renderSaldo(rows){
  const tb=document.querySelector('#tableSaldo tbody');
  tb.innerHTML="";
  let totalItens=rows.length;
  let soma=0;
  rows.forEach(i=>{
    const saldo=Number(i.SaldoAtual)||0;
    soma+=saldo;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.Title||''}</td><td>${i.CodigoFornecedor||''}</td><td>${i.DescricaoProduto||''}</td><td>${i.NomeFornecedor||''}</td><td>${i.UnidadeMedida||''}</td><td>${fmtBR(saldo)}</td><td>${i.DataAtualizacao||''}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('saldoInfo').textContent=`Itens: ${totalItens}`;
  document.getElementById('resumoSaldo').textContent=`Total de produtos: ${totalItens} | Soma total de estoque: ${fmtBR(soma,0)}`;
}
function exportarCSV(){
  const table=document.getElementById('tableSaldo');
  const rows=[...table.rows].map(tr=>[...tr.cells].map(td=>`"${(td.innerText||'').replace(/"/g,'""')}"`).join(','));
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`produtos_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

(function init(){mostrar('home');})();
</script>

</body>
</html>
